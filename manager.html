<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>لوحة المدير</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-6">
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-3xl font-bold text-center w-full">لوحة المدير - جميع الفروع</h2>
      <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white font-semibold px-4 py-2 rounded">تسجيل الخروج</button>
    </div>

    <div class="bg-white shadow-md rounded-lg p-4 mb-6 flex flex-wrap gap-4 items-center justify-center">
      <div>
        <label class="block text-sm font-medium mb-1">تصفية حسب الفرع:</label>
        <select id="branchFilter" class="rounded border-gray-300 px-3 py-2">
          <option value="">الكل</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">من:</label>
        <input type="date" id="startDate" class="rounded border-gray-300 px-3 py-2">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">إلى:</label>
        <input type="date" id="endDate" class="rounded border-gray-300 px-3 py-2">
      </div>
      <button onclick="applyFilter()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded">تصفية</button>
      <button onclick="copyTable()" class="bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded">نسخ الجدول</button>
    </div>

    <div class="overflow-x-auto bg-white shadow-md rounded-lg">
      <table id="allData" class="min-w-full table-auto text-sm">
        <thead class="bg-gray-200 text-gray-700">
          <tr>
            <th class="px-4 py-2">التاريخ</th>
            <th class="px-4 py-2">اسم الموظف</th>
            <th class="px-4 py-2">الفرع</th>
            <th class="px-4 py-2">النوع</th>
            <th class="px-4 py-2">الوصف</th>
            <th class="px-4 py-2">القيمة (دينار)</th>
          </tr>
        </thead>
        <tbody id="dataBody" class="text-center"></tbody>
      </table>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB12tfYkdfVq6xJWyG3aHJkMjQbRgBCCqk",
      authDomain: "limeted-74dd8.firebaseapp.com",
      projectId: "limeted-74dd8",
      storageBucket: "limeted-74dd8.firebasestorage.app",
      messagingSenderId: "822523906481",
      appId: "1:822523906481:web:a8673641b56dfd95711590",
      measurementId: "G-VWD34NDG63"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    firebase.auth().onAuthStateChanged(user => {
      if (!user || user.email !== "ahm7777ed20@gmail.com") {
        alert("غير مصرح لك بالدخول لهذه الصفحة.");
        window.location.href = "index.html";
      }
    });

    function logout() {
      auth.signOut().then(() => {
        window.location.href = "index.html";
      }).catch((error) => {
        console.error("خطأ في تسجيل الخروج:", error);
        alert("حدث خطأ أثناء تسجيل الخروج.");
      });
    }

    let allData = [];

    db.ref("users").once("value").then(usersSnap => {
      const users = usersSnap.val() || {};
      const branches = new Set();

      db.ref("branches").on("value", snapshot => {
        const tbody = document.getElementById("dataBody");
        tbody.innerHTML = "";
        allData = [];

        snapshot.forEach(branchSnap => {
          const uid = branchSnap.key;
          const userInfo = users[uid] || {};
          const employeeName = userInfo.name || "غير معروف";
          const branchName = userInfo.branch || "غير محدد";
          branches.add(branchName);

          branchSnap.forEach(entry => {
            const { desc, amount, type, timestamp } = entry.val();
            if (desc && amount && type && timestamp) {
              allData.push({ timestamp, employeeName, branchName, type, desc, amount: parseFloat(amount) });
            }
          });
        });

        const branchFilter = document.getElementById("branchFilter");
        branchFilter.innerHTML = '<option value="">الكل</option>';
        branches.forEach(name => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          branchFilter.appendChild(option);
        });

        renderTable(allData);
      });
    });

    function renderTable(data) {
      const tbody = document.getElementById("dataBody");
      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = `<tr>
          <td class='px-4 py-2 border'>${formatDate(row.timestamp)}</td>
          <td class='px-4 py-2 border'>${row.employeeName}</td>
          <td class='px-4 py-2 border'>${row.branchName}</td>
          <td class='px-4 py-2 border'>${row.type}</td>
          <td class='px-4 py-2 border'>${row.desc}</td>
          <td class='px-4 py-2 border'>${row.amount.toFixed(3)}</td>
        </tr>`;
        tbody.innerHTML += tr;
      });
    }

    function applyFilter() {
      const branch = document.getElementById("branchFilter").value;
      const startInput = document.getElementById("startDate").value;
      const endInput = document.getElementById("endDate").value;

      const start = startInput ? new Date(startInput + 'T00:00:00') : null;
      const end = endInput ? new Date(endInput + 'T23:59:59') : null;

      const filtered = allData.filter(row => {
        const rowDate = new Date(row.timestamp);
        const inRange = (!start || rowDate >= start) && (!end || rowDate <= end);
        const matchesBranch = !branch || row.branchName === branch;
        return inRange && matchesBranch;
      });

      renderTable(filtered);
    }

    function copyTable() {
      const range = document.createRange();
      range.selectNode(document.getElementById("allData"));
      window.getSelection().removeAllRanges();
      window.getSelection().addRange(range);
      document.execCommand("copy");
      alert("تم نسخ الجدول بنجاح!");
    }

    function formatDate(rawTimestamp) {
      const date = new Date(rawTimestamp);
      if (isNaN(date.getTime())) return rawTimestamp;

      const day = date.getDate();
      const month = date.getMonth() + 1;
      const year = date.getFullYear();
      const time = date.toLocaleTimeString('en-US');

      return `${month}/${day}/${year} ${time}`;
    }
  </script>
</body>
</html>
