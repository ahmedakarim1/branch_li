<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>صفحة الفرع</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-4xl mx-auto p-4">
    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
      <h2 id="welcome" class="text-xl font-bold text-gray-800">مرحباً</h2>
      <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">تسجيل الخروج</button>
    </div>

    <div id="setupInfo" class="bg-white p-6 rounded-lg shadow-md mt-4">
      <h2 class="text-xl font-bold text-gray-800 mb-4">أدخل بياناتك</h2>
      <div class="grid gap-4">
        <div>
          <label class="block text-gray-700 mb-1">اسم الموظف:</label>
          <input type="text" id="userName" class="w-full px-4 py-2 border rounded-md" />
        </div>
        <div>
          <label class="block text-gray-700 mb-1">اسم الفرع:</label>
          <input type="text" id="branchName" class="w-full px-4 py-2 border rounded-md" />
        </div>
        <button onclick="saveUserInfo()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-md">حفظ</button>
      </div>
    </div>

    <div id="mainApp" class="bg-white p-6 rounded-lg shadow-md mt-4 hidden">
      <div class="grid gap-4 mb-4">
        <div>
          <label class="block text-sm text-gray-700 mb-1">الوصف</label>
          <input type="text" id="desc" class="w-full px-4 py-2 border rounded-md" />
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">القيمة (دينار)</label>
          <input type="number" id="amount" step="0.001" class="w-full px-4 py-2 border rounded-md" />
        </div>
        <div>
          <label class="block text-sm text-gray-700 mb-1">النوع</label>
          <select id="type" class="w-full px-4 py-2 border rounded-md">
            <option value="دخل">دخل</option>
            <option value="خرج">خرج</option>
          </select>
        </div>
        <button onclick="addEntry()" id="addBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-md">إضافة</button>
      </div>

      <div class="overflow-x-auto mt-6">
        <table class="min-w-full text-sm text-center border">
          <thead class="bg-gray-200">
            <tr>
              <th class="px-4 py-2">اسم الموظف</th>
              <th class="px-4 py-2">اسم الفرع</th>
              <th class="px-4 py-2">الوصف</th>
              <th class="px-4 py-2">القيمة</th>
              <th class="px-4 py-2">النوع</th>
              <th class="px-4 py-2">التاريخ</th>
            </tr>
          </thead>
          <tbody id="dataBody" class="bg-white"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB12tfYkdfVq6xJWyG3aHJkMjQbRgBCCqk",
      authDomain: "limeted-74dd8.firebaseapp.com",
      projectId: "limeted-74dd8",
      storageBucket: "limeted-74dd8.firebasestorage.app",
      messagingSenderId: "822523906481",
      appId: "1:822523906481:web:a8673641b56dfd95711590",
      measurementId: "G-VWD34NDG63"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUserData = { name: "", branch: "" };

    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        const uid = user.uid;
        db.ref("users/" + uid).once("value").then(snapshot => {
          const setupInfo = document.getElementById("setupInfo");
          const mainApp = document.getElementById("mainApp");
          if (!snapshot.exists() || !snapshot.val().name || !snapshot.val().branch) {
            setupInfo.classList.remove("hidden");
            mainApp.classList.add("hidden");
          } else {
            const data = snapshot.val();
            currentUserData = data;
            setupInfo.classList.add("hidden");
            mainApp.classList.remove("hidden");
            startApp(uid, data.name, data.branch);
          }
        });
      }
    });

    function logout() {
      firebase.auth().signOut().then(() => {
        window.location.href = 'login.html';
      });
    }

    function saveUserInfo() {
      const name = document.getElementById("userName").value.trim();
      const branch = document.getElementById("branchName").value.trim();
      const uid = firebase.auth().currentUser.uid;

      if (!name || !branch) return alert("يرجى إدخال الاسم واسم الفرع.");

      db.ref("users/" + uid).set({ name, branch }).then(() => {
        document.getElementById("setupInfo").classList.add("hidden");
        document.getElementById("mainApp").classList.remove("hidden");
        startApp(uid, name, branch);
      });
    }

    function startApp(uid, name, branch) {
      currentUserData = { name, branch };
      document.getElementById("welcome").innerText = `مرحباً ${name} - فرع ${branch}`;

      const branchRef = db.ref("branches/" + uid);

      window.addEntry = function () {
        const desc = document.getElementById("desc").value;
        const amount = document.getElementById("amount").value;
        const type = document.getElementById("type").value;
        const timestamp = new Date().toLocaleString('ar-EG');

        if (!desc || !amount) return alert("يرجى إدخال الوصف والقيمة.");

        branchRef.push({
          desc,
          amount,
          type,
          timestamp,
          employeeName: currentUserData.name,
          branchName: currentUserData.branch
        });

        document.getElementById("desc").value = "";
        document.getElementById("amount").value = "";
      };

      branchRef.on("value", snapshot => {
        const tbody = document.getElementById("dataBody");
        tbody.innerHTML = "";
        snapshot.forEach(entry => {
          const { desc, amount, type, timestamp, employeeName, branchName } = entry.val();
          if (desc && amount && type && timestamp) {
            const dateOnly = new Date(timestamp).toLocaleDateString('ar-EG');
            const today = new Date().toLocaleDateString('ar-EG');
            if (dateOnly === today) {
              const row = `<tr class='border-t'>
                <td class='px-4 py-2'>${employeeName || "-"}</td>
                <td class='px-4 py-2'>${branchName || "-"}</td>
                <td class='px-4 py-2'>${desc}</td>
                <td class='px-4 py-2'>${amount}</td>
                <td class='px-4 py-2'>${type}</td>
                <td class='px-4 py-2'>${timestamp}</td>
              </tr>`;
              tbody.innerHTML += row;
            }
          }
        });
      });
    }
  </script>
</body>
</html>
